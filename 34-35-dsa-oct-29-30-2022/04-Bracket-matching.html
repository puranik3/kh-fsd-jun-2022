<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Matching brackets</title>
        <style>
            .editor {
                width: 100%;
                resize: none;
                font-size: 1.5em;
            }

            .highlight {
                background-color: yellow;
            }
        </style>
    </head>
    <body>
        <textarea id="editor" class="editor" rows="20"></textarea>
        You selected <span id="sel" class="highlight"></span>

        <script type="module">
            import Stack from './03-Stack.js';

            const editor = document.getElementById("editor");

            function getSelectionText() {
                var text = "";
                var activeEl = document.activeElement;
                var activeElTagName = activeEl
                    ? activeEl.tagName.toLowerCase()
                    : null;
                if (
                    activeElTagName == "textarea" ||
                    (activeElTagName == "input" &&
                        /^(?:text|search|password|tel|url)$/i.test(
                            activeEl.type
                        ) &&
                        typeof activeEl.selectionStart == "number")
                ) {
                    text = activeEl.value.slice(
                        activeEl.selectionStart,
                        activeEl.selectionEnd
                    );
                } else if (window.getSelection) {
                    text = window.getSelection().toString();
                }
                return {
                    text,
                    start: activeEl.selectionStart,
                    end: activeEl.selectionEnd
                };
            }

            document.onmouseup = document.onkeyup = document.onselectionchange = function () {
                const matches = {
                    '}': '{',
                    ']': '[',
                    ')': '('
                };

                const { text, start, end } = getSelectionText();
                document.getElementById( "sel" ).textContent = `${text} ${start} ${end}`;

                const bracketsStack = new Stack();

                // if the selection is a closing bracket...
                if( [ '}', ']', ')' ].includes( text ) ) {

                    const content = editor.value;

                    // we go through the editor's text character-by-character...
                    for( let i = 0; i < content.length; i++ ) {
                        
                        // if the selection is a opening bracket we record it (the position) in a stack...
                        if( [ '{', '[', '(' ].includes( content[i] ) ) {
                            bracketsStack.push( i );
                        }

                        if( [ '}', ']', ')' ].includes( content[i] ) ) {
                            // Handling error scenario #1 - the opening bracket on top of the stack is not a matching one for the closing one
                            if( content[bracketsStack.peek()] !== matches[content[i]] ) {
                                alert( 'Your code is malformed' );
                                return;
                            }

                            // @todo Handling error scenarios (the stack is empty - and we cannot pop - this will happen if the number of closing brackets so far exceeded the number of opening brackets)
                            // let's assume for now the string is well-structured
                            const openingBracket = bracketsStack.pop();

                            if( i === start ) { // we are now at the position user has highlighted
                                console.log( `opening bracket is at ${openingBracket}` );
                                editor.setSelectionRange(openingBracket, openingBracket + 1);
                            }
                        }
                    }
                }
            };
        </script>
    </body>
</html>
